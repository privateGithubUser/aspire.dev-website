---
import DefaultHeader from "@astrojs/starlight/components/Header.astro";

import SiteTitle from "@astrojs/starlight/components/SiteTitle.astro";
import SocialIcons from "@components/starlight/SocialIcons.astro";
import ThemeSelect from "@astrojs/starlight/components/ThemeSelect.astro";
import LanguageSelect from "@astrojs/starlight/components/LanguageSelect.astro";
import Search from "@astrojs/starlight/components/Search.astro";

import { isHomepage } from "@utils/helpers";
---

{
    isHomepage(Astro) ? (
        <div class="header">
            <div class="title-wrapper sl-flex" data-homepage-title>
                <SiteTitle />
            </div>
            <div class="sl-flex print:hidden homepage-search" data-homepage-search>
                <Search />
            </div>
            <div class="sl-hidden md:sl-flex print:hidden right-group">
                <div class="sl-flex social-icons">
                    <SocialIcons />
                </div>
                <ThemeSelect />
                <LanguageSelect />
            </div>
        </div>
    ) : (
        <DefaultHeader>
            <slot />
        </DefaultHeader>
    )
}

<script>
    // Store the AbortController to manage scroll listener lifecycle
    let scrollController: AbortController | null = null;

    function initHomepageHeader() {
        // Abort any existing scroll listener before setting up a new one
        if (scrollController) {
            scrollController.abort();
        }
        scrollController = new AbortController();

        const searchWrapper = document.querySelector('[data-homepage-search]');
        const titleWrapper = document.querySelector('[data-homepage-title]');
        const siteTitleText = titleWrapper?.querySelector('.site-title .sr-only');
        if (!searchWrapper && !siteTitleText) return;

        const hero = document.querySelector('.hero');
        if (!hero) {
            // If no hero found, show elements immediately
            searchWrapper?.classList.add('visible');
            siteTitleText?.classList.add('visible');
            return;
        }

        function checkScroll() {
            const heroRect = hero.getBoundingClientRect();
            // Show elements when the bottom of the hero is at or above the top of the viewport
            if (heroRect.bottom <= 0) {
                searchWrapper?.classList.add('visible');
                siteTitleText?.classList.add('visible');
            } else {
                searchWrapper?.classList.remove('visible');
                siteTitleText?.classList.remove('visible');
            }
        }

        let ticking = false;
        function onScroll() {
            if (!ticking) {
                ticking = true;
                window.requestAnimationFrame(() => {
                    checkScroll();
                    ticking = false;
                });
            }
        }

        // Check on initial load
        checkScroll();

        // Check on scroll (throttled with requestAnimationFrame)
        // Use AbortController signal to automatically remove listener when aborted
        window.addEventListener('scroll', onScroll, {
            passive: true,
            signal: scrollController!.signal,
        });
    }

    // Run on initial load
    initHomepageHeader();

    // Re-run on Astro page transitions (View Transitions)
    document.addEventListener('astro:after-swap', initHomepageHeader);
</script>

<style>
    .homepage-search {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .homepage-search.visible {
        opacity: 1;
        pointer-events: auto;
    }

    /* Site title text - hidden by default on homepage, shown when scrolling */
    /* Use :global() to escape Astro's scoped CSS since .sr-only is in SiteTitle component */
    [data-homepage-title] :global(a.site-title .sr-only.visible) {
        position: initial !important;
        width: auto !important;
        height: auto !important;
        margin: initial !important;
        padding: initial !important;
        clip: auto !important;
        overflow: visible !important;
        white-space: normal !important;
    }

    @layer starlight.core {
        .header {
            display: flex;
            gap: var(--sl-nav-gap);
            justify-content: space-between;
            align-items: center;
            height: 100%;
        }

        .title-wrapper {
            /* Prevent long titles overflowing and covering the search and menu buttons on narrow viewports. */
            overflow: clip;
            /* Avoid clipping focus ring around link inside title wrapper. */
            padding: 0.25rem;
            margin: -0.25rem;
            min-width: 0;
        }

        .right-group,
        .social-icons {
            gap: 1rem;
            align-items: center;
        }

        .social-icons::after {
            content: "";
            height: 2rem;
            border-inline-end: 1px solid var(--sl-color-gray-5);
        }

        @media (min-width: 50rem) {
            :global(:root[data-has-sidebar]) {
                --__sidebar-pad: calc(2 * var(--sl-nav-pad-x));
            }
            :global(:root:not([data-has-toc])) {
                --__toc-width: 0rem;
            }
            .header {
                --__sidebar-width: max(
                    0rem,
                    var(--sl-content-inline-start, 0rem) - var(--sl-nav-pad-x)
                );
                --__main-column-fr: calc(
                    (
                            100% + var(--__sidebar-pad, 0rem) -
                                var(--__toc-width, var(--sl-sidebar-width)) -
                                (2 * var(--__toc-width, var(--sl-nav-pad-x))) -
                                var(--sl-content-inline-start, 0rem) -
                                var(--sl-content-width)
                        ) / 2
                );
                display: grid;
                grid-template-columns:
        /* 1 (site title): runs up until the main content columnâ€™s left edge or the width of the title, whichever is the largest  */
                    minmax(
                        calc(
                            var(--__sidebar-width) +
                                max(
                                    0rem,
                                    var(--__main-column-fr) - var(--sl-nav-gap)
                                )
                        ),
                        auto
                    )
                    /* 2 (search box): all free space that is available. */
                    1fr
                    /* 3 (right items): use the space that these need. */
                    auto;
                align-content: center;
            }
        }
    }
</style>
